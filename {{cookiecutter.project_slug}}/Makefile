# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Makefile for C++ gRPC Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PROJECT        := {{ cookiecutter.project_slug }}
LANG           := {{ cookiecutter.language }}
BUILD_DIR      := build
BIN_DIR        := bin
PROTO_DIR      := pkg/proto/v1
PLATFORM       := $(shell uname -m)
PROTO_FILES    := $(wildcard $(PROTO_DIR)/*.proto)

CMAKE_FLAGS    := -DCMAKE_BUILD_TYPE=Release

# C++ targets
ifeq ($(LANG),cpp)
.PHONY: all build test clean docker-build docker-run

build:
	@echo "ğŸ”¨ Building C++ binaryâ€¦"
	@mkdir -p build
	cmake -S src/cpp -B build CMAKE_FLAGS
	cmake --build build

test:
	@echo "âœ… Running C++ testsâ€¦"
	cd build && ctest --output-on-failure

docker-build:
	@echo "ğŸ³ Building C++ Docker imageâ€¦"
	docker build -f Dockerfile.cpp -t $(PROJECT)-cpp:local .

docker-run: docker-build
	@echo "ğŸš€ Running C++ Docker containerâ€¦"
	docker run --rm -p 50051:50051 $(PROJECT)-cpp:local

clean:
	rm -rf build

endif

ifeq ($(LANG),go)

.PHONY: install build test docker-build docker-run clean generate clean-proto clean clean-generate

GO_TESTDIR             := test


install:
	@echo "ğŸ› ï¸  Installing Go dependenciesâ€¦"

ifeq ($(PLATFORM),arm64)
	@if ! command -v go >/dev/null 2>&1; then \
		echo "ğŸ Apple Silicon detected, installing Go via Homebrew..."; \
		brew install go; \
	else \
		echo "âœ… Go is already installed."; \
	fi
endif

	@for pkg in \
		google.golang.org/protobuf/cmd/protoc-gen-go@latest \
		google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest; do \
		binary=$$(basename $$pkg | cut -d'@' -f1); \
		if ! command -v $$binary >/dev/null 2>&1; then \
			echo "â¬‡ï¸  Installing $$binary..."; \
			go install $$pkg; \
		else \
			echo "âœ… $$binary already installed."; \
		fi; \
	done

generate: install
	@echo "âš™ï¸  Generating Go code from .protoâ€¦"
	PATH="$(shell go env GOPATH)/bin:$(PATH)" protoc \
		-I $(PROTO_DIR) \
		--go_out=paths=source_relative:$(PROTO_DIR) \
		--go-grpc_out=paths=source_relative:$(PROTO_DIR) \
		$(PROTO_FILES)
		# ğŸ§¹ Ensure go.mod/go.sum reflect any new or removed imports introduced by the generated code
		go mod tidy

test: generate
	@echo "âœ… Running Go testsâ€¦"
	cd $(GO_TESTDIR) && go test ./...

build:
	@echo "ğŸ”¨ Building Go Docker imageâ€¦"
	docker build -f Dockerfile -t $(PROJECT)-go:local .

run: build
	@echo "ğŸš€ Running Go Docker containerâ€¦"
	docker run --rm -p 50051:50051 $(PROJECT)-go:local

clean-generate:
	@echo "ğŸ§¹ Cleaning build artifactsâ€¦"
	rm -rf $(BIN_DIR)

clean-proto:
	@echo "ğŸ§¹ Cleaning generated proto filesâ€¦"
	rm -rf $(PROTO_DIR)/*.pb.go

clean: clean-generate clean-proto

skaffold:
	@echo "ğŸš€ Starting Skaffold in development mode with Go services..."
	skaffold dev -p dev

endif
